<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= listing.title %></title>
    
    <!-- Include Mapbox GL JS CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet" />
    
    <!-- Include Mapbox GL JS script -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
</head>
<body>
    <!-- Listing Details -->
    <h1><%= listing.title %></h1>
    <p><%= listing.location %></p>
    <p><%= listing.description %></p>

    <!-- Map container -->
    <div id="map" style="height: 500px;"></div> <!-- Make sure the height is set to something like 500px or more for the map to show -->

    <script>
        // Pass the Mapbox token from the controller to the frontend (embedding from EJS)
        window.mapToken = "<%= mapToken %>";  // This is where we pass the token from the controller

        // Ensure mapToken is defined before initializing the map
        if (window.mapToken) {
            mapboxgl.accessToken = window.mapToken;  // Use the token for Mapbox GL

            // Initialize the Mapbox map
            const map = new mapboxgl.Map({
                container: 'map', // ID of the HTML element where the map will be rendered
                style: 'mapbox://styles/mapbox/streets-v11', // Choose a map style
                center: <%= JSON.stringify(listing.geometry.coordinates) %>, // Coordinates from the listing geometry
                zoom: 9 // Initial zoom level
            });

            // Add a red marker at the listing's coordinates
            new mapboxgl.Marker({ color: "red" })
                .setLngLat(<%= JSON.stringify(listing.geometry.coordinates) %>)  // Coordinates of the listing
                .setPopup(new mapboxgl.Popup({ offset: 25 }) // Add a popup with the title and location
                    .setHTML(`<h4><%= listing.title %></h4><p><%= listing.location %></p>`))
                .addTo(map);
        } else {
            console.error('Map token is not defined.');
        }
    </script>
</body>
</html>
